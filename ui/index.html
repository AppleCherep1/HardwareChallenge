<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual Reception</title>
  <style>
    body { margin:0; font-family: system-ui, Arial; background:#0b1220; color:#e8eefc; }
    .wrap { display:flex; height:100vh; }
    .left { flex:1; display:flex; align-items:center; justify-content:center; position:relative; }
    .avatar {
      width:min(70vh, 70vw); height:min(70vh, 70vw);
      border-radius:24px; background:#111a30; display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .avatar span { opacity:.75; font-size:22px; text-align:center; padding:24px; }
    .status { position:absolute; top:18px; left:18px; padding:8px 12px; border-radius:999px;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); }
    .right { width:520px; max-width:45vw; border-left:1px solid rgba(255,255,255,.10);
      padding:18px; display:flex; flex-direction:column; gap:12px; background:#0f1730; }
    .card { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:14px; }
    .label { opacity:.7; font-size:12px; margin-bottom:6px; }
    .txt { font-size:16px; line-height:1.35; white-space:pre-wrap; }
    .result { font-size:18px; line-height:1.35; font-weight:700; }
    .btns { display:flex; gap:10px; margin-top:auto; }
    button { flex:1; padding:14px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08); color:#e8eefc; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .hint { opacity:.7; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <div class="status" id="mode">mode: ...</div>
      <div class="avatar">
        <img id="avatarImg" src="/ui/avatar_idle.png" alt="avatar"
             style="width:100%; height:100%; object-fit:cover; border-radius:24px;">
      </div>

    </div>

    <div class="right">
      <div class="card">
        <div class="label">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª</div>
        <div class="txt" id="userText">‚Äî</div>
      </div>

      <div class="card">
        <div class="label">–û—Ç–≤–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞</div>
        <div class="txt" id="replyText">‚Äî</div>
      </div>

      <div class="card">
        <div class="label">–ò—Ç–æ–≥ (–∫—É–¥–∞ –ø—Ä–æ–π—Ç–∏)</div>
        <div class="result" id="resultText">‚Äî</div>
        <div class="hint">–ò—Ç–æ–≥ –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ ¬´–†–ï–ó–£–õ–¨–¢–ê–¢: ...¬ª –≤ –æ—Ç–≤–µ—Ç–µ.</div>
      </div>

      <div class="btns">
        <button id="startBtn">üéôÔ∏è –°–∫–∞–∑–∞—Ç—å (5 —Å–µ–∫)</button>
        <button id="resetBtn">‚Ü©Ô∏è –°–±—Ä–æ—Å</button>
      </div>
      <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ —à—É–º–Ω–æ ‚Äî –≥–æ–≤–æ—Ä–∏ —á—ë—Ç–∫–æ —Ä—è–¥–æ–º —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º.</div>
    </div>
  </div>

<script>
const API = "http://127.0.0.1:8000";

const modeEl = document.getElementById("mode");
const avatarImg = document.getElementById("avatarImg");
const userEl = document.getElementById("userText");
const replyEl = document.getElementById("replyText");
const resultEl = document.getElementById("resultText");
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");

function extractResult(reply) {
  const m = reply.match(/–†–ï–ó–£–õ–¨–¢–ê–¢:\s*(.+)/i);
  return m ? m[1].trim() : "‚Äî";
}

function speak(text) {
  if (!("speechSynthesis" in window)) {
    console.log("TTS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ");
    return;
  }

  // –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ–∑–≤—É—á–∫—É
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ru-RU";
  u.rate = 1.0;   // —Å–∫–æ—Ä–æ—Å—Ç—å
  u.pitch = 1.0;  // —Ç–æ–Ω

  // –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤—ã–±—Ä–∞—Ç—å —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const voices = window.speechSynthesis.getVoices();
  const ru = voices.find(v => (v.lang || "").toLowerCase().startsWith("ru"));
  if (ru) u.voice = ru;

  // –∞–≤–∞—Ç–∞—Ä "–≥–æ–≤–æ—Ä–∏—Ç" –≤–æ –≤—Ä–µ–º—è TTS
  if (typeof avatarImg !== "undefined" && avatarImg) {
    u.onstart = () => { avatarImg.src = "/ui/avatar_talk.png"; };
    u.onend   = () => { avatarImg.src = "/ui/avatar_idle.png"; };
    u.onerror = () => { avatarImg.src = "/ui/avatar_idle.png"; };
  }

  window.speechSynthesis.speak(u);
}

// –≤–∞–∂–Ω–æ: –∏–Ω–æ–≥–¥–∞ –≥–æ–ª–æ—Å–∞ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–µ —Å—Ä–∞–∑—É
window.speechSynthesis.onvoiceschanged = () => {
  window.speechSynthesis.getVoices();
};

async function refreshStatus() {
  try {
    const r = await fetch(API + "/status");
    const s = await r.json();
    const mode = (s.mode || "idle");
    modeEl.textContent = "mode: " + mode;

    // –•–∞–∫: speaking -> talk, –∏–Ω–∞—á–µ idle
    if (mode === "speaking") {
      avatarImg.src = "/ui/avatar_talk.png";
    } else {
      avatarImg.src = "/ui/avatar_idle.png";
    }

  } catch (e) {
    modeEl.textContent = "mode: offline";
  }
}

async function doStep() {
  startBtn.disabled = true;
  startBtn.textContent = "‚è≥ –ó–∞–ø–∏—Å—å/–æ–±—Ä–∞–±–æ—Ç–∫–∞...";
  try {
    const r = await fetch(API + "/step", { method: "POST" });
    const j = await r.json();
    userEl.textContent = j.user_text || "‚Äî";
    replyEl.textContent = j.reply || "‚Äî";
    resultEl.textContent = extractResult(j.reply || "");
    // –æ–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç (–±–µ–∑ —Å—Ç—Ä–æ–∫–∏ "–†–ï–ó–£–õ–¨–¢–ê–¢", —á—Ç–æ–±—ã –∑–≤—É—á–∞–ª–æ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏)
    const spoken = (j.reply || "").replace(/–†–ï–ó–£–õ–¨–¢–ê–¢:.*$/i, "").trim();
    if (spoken) speak(spoken);
  } catch (e) {
    replyEl.textContent = "–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω.";
  } finally {
    startBtn.disabled = false;
    startBtn.textContent = "üéôÔ∏è –°–∫–∞–∑–∞—Ç—å (5 —Å–µ–∫)";
  }
}

async function doReset() {
  await fetch(API + "/reset", { method: "POST" });
  userEl.textContent = "‚Äî";
  replyEl.textContent = "‚Äî";
  resultEl.textContent = "‚Äî";
}

startBtn.onclick = doStep;
resetBtn.onclick = doReset;

setInterval(refreshStatus, 500);
refreshStatus();
</script>
</body>
</html>